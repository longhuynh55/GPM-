{% extends 'base.html' %}

{% block title %}So Sánh - Phân Tích Tài Chính{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-body">
                <h2 class="card-title text-center mb-4">So Sánh Tài Chính</h2>
                <p class="lead text-center">
                    So sánh các chỉ số tài chính giữa các doanh nghiệp hoặc giữa các ngành trên thị trường chứng khoán
                    Việt Nam.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Comparison Selection -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Lựa Chọn So Sánh</h5>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="comparisonTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="companies-tab" data-bs-toggle="tab"
                            data-bs-target="#companies" type="button" role="tab">
                            So Sánh Các Công Ty
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="sectors-tab" data-bs-toggle="tab" data-bs-target="#sectors"
                            type="button" role="tab">
                            So Sánh Các Ngành
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="company-with-sector-tab" data-bs-toggle="tab"
                            data-bs-target="#company-with-sector" type="button" role="tab">
                            So Sánh Công Ty Với Ngành
                        </button>
                    </li>
                </ul>
                <div class="tab-content mt-3" id="comparisonTabContent">
                    <div class="tab-pane fade show active" id="companies" role="tabpanel">
                        <form id="companiesComparisonForm" method="get">
                            <input type="hidden" name="type" value="companies">
                            <div class="row mb-3">
                                <div class="col-md-5">
                                    <label for="company1" class="form-label">Công Ty Thứ Nhất</label>
                                    <input type="text" class="form-control" id="company1" name="company1"
                                        placeholder="Nhập mã cổ phiếu (VD: VNM)"
                                        value="{{ company1 if company1 else '' }}">
                                </div>
                                <div class="col-md-5">
                                    <label for="company2" class="form-label">Công Ty Thứ Hai</label>
                                    <input type="text" class="form-control" id="company2" name="company2"
                                        placeholder="Nhập mã cổ phiếu (VD: MSN)"
                                        value="{{ company2 if company2 else '' }}">
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button type="submit" class="btn btn-primary w-100">So Sánh</button>
                                </div>
                            </div>
                            
                            <!-- Financial Statement Selection -->
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="showBalanceSheet" name="show_balance_sheet" 
                                               {% if show_balance_sheet %}checked{% endif %}>
                                        <label class="form-check-label" for="showBalanceSheet">
                                            Bảng Cân Đối Kế Toán (BCDKT)
                                        </label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="showIncomeStatement" name="show_income_statement"
                                               {% if show_income_statement %}checked{% endif %}>
                                        <label class="form-check-label" for="showIncomeStatement">
                                            Kết Quả Kinh Doanh (KQKD)
                                        </label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="showCashFlow" name="show_cash_flow"
                                               {% if show_cash_flow %}checked{% endif %}>
                                        <label class="form-check-label" for="showCashFlow">
                                            Lưu Chuyển Tiền Tệ (LCTT)
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="addCompany"
                                            name="addCompany">
                                        <label class="form-check-label" for="addCompany">
                                            Thêm công ty thứ ba
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-2 company3-row d-none">
                                <div class="col-md-5">
                                    <label for="company3" class="form-label">Công Ty Thứ Ba</label>
                                    <input type="text" class="form-control" id="company3" name="company3"
                                        placeholder="Nhập mã cổ phiếu (VD: FPT)"
                                        value="{{ company3 if company3 else '' }}">
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="tab-pane fade" id="sectors" role="tabpanel">
                        <form id="sectorsComparisonForm" method="get">
                            <input type="hidden" name="type" value="sectors">
                            <div class="row mb-3">
                                <div class="col-md-5">
                                    <label for="sector1" class="form-label">Ngành Thứ Nhất</label>
                                    <select class="form-select" id="sector1" name="sector1">
                                        <option value="" selected disabled>Chọn ngành...</option>
                                        {% for sector in sectors %}
                                        <option value="{{ sector }}" {% if sector1==sector %}selected{% endif %}>{{
                                            sector }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-5">
                                    <label for="sector2" class="form-label">Ngành Thứ Hai</label>
                                    <select class="form-select" id="sector2" name="sector2">
                                        <option value="" selected disabled>Chọn ngành...</option>
                                        {% for sector in sectors %}
                                        <option value="{{ sector }}" {% if sector2==sector %}selected{% endif %}>{{
                                            sector }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button type="submit" class="btn btn-primary w-100">So Sánh</button>
                                </div>
                            </div>
                            
                            <!-- Financial Statement Selection -->
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="showBalanceSheetSector" name="show_balance_sheet" 
                                               {% if show_balance_sheet %}checked{% endif %}>
                                        <label class="form-check-label" for="showBalanceSheetSector">
                                            Bảng Cân Đối Kế Toán (BCDKT)
                                        </label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="showIncomeStatementSector" name="show_income_statement"
                                               {% if show_income_statement %}checked{% endif %}>
                                        <label class="form-check-label" for="showIncomeStatementSector">
                                            Kết Quả Kinh Doanh (KQKD)
                                        </label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="showCashFlowSector" name="show_cash_flow"
                                               {% if show_cash_flow %}checked{% endif %}>
                                        <label class="form-check-label" for="showCashFlowSector">
                                            Lưu Chuyển Tiền Tệ (LCTT)
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="addSector" name="addSector">
                                        <label class="form-check-label" for="addSector">
                                            Thêm ngành thứ ba
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-2 sector3-row d-none">
                                <div class="col-md-5">
                                    <label for="sector3" class="form-label">Ngành Thứ Ba</label>
                                    <select class="form-select" id="sector3" name="sector3">
                                        <option value="" selected disabled>Chọn ngành...</option>
                                        {% for sector in sectors %}
                                        <option value="{{ sector }}" {% if sector3==sector %}selected{% endif %}>{{
                                            sector }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="tab-pane fade" id="company-with-sector" role="tabpanel">
                        <form id="companyWithSectorForm" method="get">
                            <input type="hidden" name="type" value="company_with_sector">
                            <div class="row mb-3">
                                <div class="col-md-5">
                                    <label for="company" class="form-label">Công Ty</label>
                                    <input type="text" class="form-control" id="company" name="company"
                                        placeholder="Nhập mã cổ phiếu (VD: VNM)"
                                        value="{{ company if company else '' }}">
                                </div>
                                <div class="col-md-5">
                                    <label for="sector" class="form-label">Ngành</label>
                                    <select class="form-select" id="sector" name="sector">
                                        <option value="" selected disabled>Chọn ngành...</option>
                                        {% for sector in sectors %}
                                        <option value="{{ sector }}" {% if sector==selected_sector %}selected{% endif
                                            %}>{{ sector }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button type="submit" class="btn btn-primary w-100">So Sánh</button>
                                </div>
                            </div>
                            
                            <!-- Financial Statement Selection -->
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="showBalanceSheetComp" name="show_balance_sheet" 
                                               {% if show_balance_sheet %}checked{% endif %}>
                                        <label class="form-check-label" for="showBalanceSheetComp">
                                            Bảng Cân Đối Kế Toán (BCDKT)
                                        </label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="showIncomeStatementComp" name="show_income_statement"
                                               {% if show_income_statement %}checked{% endif %}>
                                        <label class="form-check-label" for="showIncomeStatementComp">
                                            Kết Quả Kinh Doanh (KQKD)
                                        </label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="showCashFlowComp" name="show_cash_flow"
                                               {% if show_cash_flow %}checked{% endif %}>
                                        <label class="form-check-label" for="showCashFlowComp">
                                            Lưu Chuyển Tiền Tệ (LCTT)
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if comparison_type %}
<!-- Financial Statement Comparison -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">So Sánh Báo Cáo Tài Chính</h5>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="financialStatementTabs" role="tablist">
                    {% if show_balance_sheet %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="balance-sheet-tab" data-bs-toggle="tab" 
                                data-bs-target="#balance-sheet" type="button" role="tab">
                            Bảng Cân Đối Kế Toán
                        </button>
                    </li>
                    {% endif %}
                    {% if show_income_statement %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {% if not show_balance_sheet %}active{% endif %}" 
                                id="income-statement-tab" data-bs-toggle="tab" 
                                data-bs-target="#income-statement" type="button" role="tab">
                            Kết Quả Kinh Doanh
                        </button>
                    </li>
                    {% endif %}
                    {% if show_cash_flow %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {% if not show_balance_sheet and not show_income_statement %}active{% endif %}" 
                                id="cash-flow-tab" data-bs-toggle="tab" 
                                data-bs-target="#cash-flow" type="button" role="tab">
                            Lưu Chuyển Tiền Tệ
                        </button>
                    </li>
                    {% endif %}
                </ul>
                <div class="tab-content mt-3" id="financialStatementsContent">
                    {% if show_balance_sheet %}
                    <!-- Balance Sheet Tab -->
                    <div class="tab-pane fade show active" id="balance-sheet" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped">
                                <thead>
                                    <tr>
                                        <th>Chỉ Tiêu</th>
                                        {% for entity in comparison_results.financial_statements.balance_sheet.entities %}
                                        <th colspan="{{ comparison_results.financial_statements.balance_sheet.years|length }}">
                                            {{ entity.name }}
                                        </th>
                                        {% endfor %}
                                    </tr>
                                    <tr>
                                        <th></th>
                                        {% for entity in comparison_results.financial_statements.balance_sheet.entities %}
                                        {% for year in comparison_results.financial_statements.balance_sheet.years %}
                                        <th>{{ year }}</th>
                                        {% endfor %}
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Tổng tài sản</td>
                                        {% for entity in comparison_results.financial_statements.balance_sheet.entities %}
                                        {% for year in comparison_results.financial_statements.balance_sheet.years %}
                                        <td>{{ "{:,.0f}".format(entity.data.get(year, {}).get('total_assets', 0)) }}</td>
                                        {% endfor %}
                                        {% endfor %}
                                    </tr>
                                    <tr>
                                        <td>Tài sản ngắn hạn</td>
                                        {% for entity in comparison_results.financial_statements.balance_sheet.entities %}
                                        {% for year in comparison_results.financial_statements.balance_sheet.years %}
                                        <td>{{ "{:,.0f}".format(entity.data.get(year, {}).get('current_assets', 0)) }}</td>
                                        {% endfor %}
                                        {% endfor %}
                                    </tr>
                                    <tr>
                                        <td>Tài sản dài hạn</td>
                                        {% for entity in comparison_results.financial_statements.balance_sheet.entities %}
                                        {% for year in comparison_results.financial_statements.balance_sheet.years %}
                                        <td>{{ "{:,.0f}".format(entity.data.get(year, {}).get('non_current_assets', 0)) }}</td>
                                        {% endfor %}
                                        {% endfor %}
                                    </tr>
                                    <tr>
                                        <td>Nợ phải trả</td>
                                        {% for entity in comparison_results.financial_statements.balance_sheet.entities %}
                                        {% for year in comparison_results.financial_statements.balance_sheet.years %}
                                        <td>{{ "{:,.0f}".format(entity.data.get(year, {}).get('liabilities', 0)) }}</td>
                                        {% endfor %}
                                        {% endfor %}
                                    </tr>
                                    <tr>
                                        <td>Vốn chủ sở hữu</td>
                                        {% for entity in comparison_results.financial_statements.balance_sheet.entities %}
                                        {% for year in comparison_results.financial_statements.balance_sheet.years %}
                                        <td>{{ "{:,.0f}".format(entity.data.get(year, {}).get('equity', 0)) }}</td>
                                        {% endfor %}
                                        {% endfor %}
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if show_income_statement %}
                    <!-- Income Statement Tab -->
                    <div class="tab-pane fade {% if not show_balance_sheet %}show active{% endif %}" 
                         id="income-statement" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped">
                                <thead>
                                    <tr>
                                        <th>Chỉ Tiêu</th>
                                        {% for entity in comparison_results.financial_statements.income_statement.entities %}
                                        <th colspan="{{ comparison_results.financial_statements.income_statement.years|length }}">
                                            {{ entity.name }}
                                        </th>
                                        {% endfor %}
                                    </tr>
                                    <tr>
                                        <th></th>
                                        {% for entity in comparison_results.financial_statements.income_statement.entities %}
                                        {% for year in comparison_results.financial_statements.income_statement.years %}
                                        <th>{{ year }}</th>
                                        {% endfor %}
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Doanh thu thuần</td>
                                        {% for entity in comparison_results.financial_statements.income_statement.entities %}
                                        {% for year in comparison_results.financial_statements.income_statement.years %}
                                        <td>{{ "{:,.0f}".format(entity.data.get(year, {}).get('revenue', 0)) }}</td>
                                        {% endfor %}
                                        {% endfor %}
                                    </tr>
                                    <tr>
                                        <td>Lợi nhuận gộp</td>
                                        {% for entity in comparison_results.financial_statements.income_statement.entities %}
                                        {% for year in comparison_results.financial_statements.income_statement.years %}
                                        <td>{{ "{:,.0f}".format(entity.data.get(year, {}).get('gross_profit', 0)) }}</td>
                                        {% endfor %}
                                        {% endfor %}
                                    </tr>
                                    <tr>
                                        <td>Lợi nhuận thuần từ HĐKD</td>
                                        {% for entity in comparison_results.financial_statements.income_statement.entities %}
                                        {% for year in comparison_results.financial_statements.income_statement.years %}
                                        <td>{{ "{:,.0f}".format(entity.data.get(year, {}).get('operating_profit', 0)) }}</td>
                                        {% endfor %}
                                        {% endfor %}
                                    </tr>
                                    <tr>
                                        <td>Lợi nhuận trước thuế</td>
                                        {% for entity in comparison_results.financial_statements.income_statement.entities %}
                                        {% for year in comparison_results.financial_statements.income_statement.years %}
                                        <td>{{ "{:,.0f}".format(entity.data.get(year, {}).get('profit_before_tax', 0)) }}</td>
                                        {% endfor %}
                                        {% endfor %}
                                    </tr>
                                    <tr>
                                        <td>Lợi nhuận sau thuế</td>
                                        {% for entity in comparison_results.financial_statements.income_statement.entities %}
                                        {% for year in comparison_results.financial_statements.income_statement.years %}
                                        <td>{{ "{:,.0f}".format(entity.data.get(year, {}).get('net_profit', 0)) }}</td>
                                        {% endfor %}
                                        {% endfor %}
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if show_cash_flow %}
                    <!-- Cash Flow Tab -->
                    <div class="tab-pane fade {% if not show_balance_sheet and not show_income_statement %}show active{% endif %}" 
                         id="cash-flow" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped">
                                <thead>
                                    <tr>
                                        <th>Chỉ Tiêu</th>
                                        {% for entity in comparison_results.financial_statements.cash_flow.entities %}
                                        <th colspan="{{ comparison_results.financial_statements.cash_flow.years|length }}">
                                            {{ entity.name }}
                                        </th>
                                        {% endfor %}
                                    </tr>
                                    <tr>
                                        <th></th>
                                        {% for entity in comparison_results.financial_statements.cash_flow.entities %}
                                        {% for year in comparison_results.financial_statements.cash_flow.years %}
                                        <th>{{ year }}</th>
                                        {% endfor %}
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Dòng tiền từ HĐKD</td>
                                        {% for entity in comparison_results.financial_statements.cash_flow.entities %}
                                        {% for year in comparison_results.financial_statements.cash_flow.years %}
                                        <td>{{ "{:,.0f}".format(entity.data.get(year, {}).get('operating_cash_flow', 0)) }}</td>
                                        {% endfor %}
                                        {% endfor %}
                                    </tr>
                                    <tr>
                                        <td>Dòng tiền từ HĐ đầu tư</td>
                                        {% for entity in comparison_results.financial_statements.cash_flow.entities %}
                                        {% for year in comparison_results.financial_statements.cash_flow.years %}
                                        <td>{{ "{:,.0f}".format(entity.data.get(year, {}).get('investing_cash_flow', 0)) }}</td>
                                        {% endfor %}
                                        {% endfor %}
                                    </tr>
                                    <tr>
                                        <td>Dòng tiền từ HĐ tài chính</td>
                                        {% for entity in comparison_results.financial_statements.cash_flow.entities %}
                                        {% for year in comparison_results.financial_statements.cash_flow.years %}
                                        <td>{{ "{:,.0f}".format(entity.data.get(year, {}).get('financing_cash_flow', 0)) }}</td>
                                        {% endfor %}
                                        {% endfor %}
                                    </tr>
                                    <tr>
                                        <td>Dòng tiền thuần</td>
                                        {% for entity in comparison_results.financial_statements.cash_flow.entities %}
                                        {% for year in comparison_results.financial_statements.cash_flow.years %}
                                        <td>{{ "{:,.0f}".format(entity.data.get(year, {}).get('net_cash_flow', 0)) }}</td>
                                        {% endfor %}
                                        {% endfor %}
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Comparison Results -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Kết Quả So Sánh</h5>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-12">
                        <h4 class="text-center mb-3">
                            {% if comparison_type == 'companies' %}
                            So Sánh Giữa {{ company1 }}{% if company2 %}, {{ company2 }}{% endif %}{% if company3 %} và
                            {{ company3 }}{% endif %}
                            {% elif comparison_type == 'sectors' %}
                            So Sánh Giữa Ngành {{ sector1 }}{% if sector2 %}, {{ sector2 }}{% endif %}{% if sector3 %}
                            và {{ sector3 }}{% endif %}
                            {% elif comparison_type == 'company_with_sector' %}
                            So Sánh Giữa {{ company }} và Ngành {{ sector }}
                            {% endif %}
                        </h4>
                    </div>
                </div>

                <!-- Comparison Tabs -->
                <ul class="nav nav-tabs" id="comparisonResultTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab"
                            data-bs-target="#overview" type="button" role="tab">
                            Tổng Quan
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="profitability-tab" data-bs-toggle="tab"
                            data-bs-target="#profitability" type="button" role="tab">
                            Khả Năng Sinh Lời
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="leverage-tab" data-bs-toggle="tab" data-bs-target="#leverage"
                            type="button" role="tab">
                            Đòn Bẩy
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="growth-tab" data-bs-toggle="tab" data-bs-target="#growth"
                            type="button" role="tab">
                            Tăng Trưởng
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="valuation-tab" data-bs-toggle="tab" data-bs-target="#valuation"
                            type="button" role="tab">
                            Định Giá
                        </button>
                    </li>
                </ul>
                <div class="tab-content mt-3" id="comparisonResultTabContent">
                    <!-- Overview Tab -->
                    <div class="tab-pane fade show active" id="overview" role="tabpanel">
                        <div class="row">
                            <div class="col-md-8">
                                <canvas id="overviewChart" height="400"></canvas>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Phân Tích Tổng Quan</h5>
                                        <p class="card-text">
                                            So sánh các chỉ số tài chính quan trọng nhất giữa {% if comparison_type ==
                                            'companies' %}các công ty{% elif comparison_type == 'sectors' %}các ngành{%
                                            else %}công ty và ngành{% endif %}.
                                        </p>
                                        <p class="card-text">
                                            <strong>Nhận Xét:</strong> {{ comparison_results.overview_comment }}
                                        </p>
                                    </div>
                                </div>
                                <div class="table-responsive mt-3">
                                    <table class="table table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Chỉ Số</th>
                                                {% for entity in comparison_results.overview %}
                                                <th>{{ entity.name }}</th>
                                                {% endfor %}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>ROE (%)</td>
                                                {% for entity in comparison_results.overview %}
                                                <td class="text-center">{{ "%.2f"|format(entity.roe) }}</td>
                                                {% endfor %}
                                            </tr>
                                            <tr>
                                                <td>ROA (%)</td>
                                                {% for entity in comparison_results.overview %}
                                                <td class="text-center">{{ "%.2f"|format(entity.roa) }}</td>
                                                {% endfor %}
                                            </tr>
                                            <tr>
                                                <td>ROS (%)</td>
                                                {% for entity in comparison_results.overview %}
                                                <td class="text-center">{{ "%.2f"|format(entity.ros) }}</td>
                                                {% endfor %}
                                            </tr>
                                            <tr>
                                                <td>Nợ/VCSH (%)</td>
                                                {% for entity in comparison_results.overview %}
                                                <td class="text-center">{{ "%.2f"|format(entity.debt_to_equity) }}</td>
                                                {% endfor %}
                                            </tr>
                                            <tr>
                                                <td>Thanh Toán Hiện Hành</td>
                                                {% for entity in comparison_results.overview %}
                                                <td class="text-center">{{ "%.2f"|format(entity.current_ratio) }}</td>
                                                {% endfor %}
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Other tabs content remains the same -->
                    <!-- ... Remaining tabs (profitability, leverage, growth, valuation) ... -->
                    
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Historical Comparison -->
<!-- ... Rest of the comparison.html file unchanged ... -->

{% endif %}
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Add company or sector checkbox handler
        const addCompanyCheckbox = document.getElementById('addCompany');
        if (addCompanyCheckbox) {
            addCompanyCheckbox.addEventListener('change', function () {
                document.querySelector('.company3-row').classList.toggle('d-none', !this.checked);
            });
        }

        const addSectorCheckbox = document.getElementById('addSector');
        if (addSectorCheckbox) {
            addSectorCheckbox.addEventListener('change', function () {
                document.querySelector('.sector3-row').classList.toggle('d-none', !this.checked);
            });
        }

        // Set active tab based on comparison type
        if ('{{ comparison_type }}' === 'companies') {
            document.getElementById('companies-tab').click();
        } else if ('{{ comparison_type }}' === 'sectors') {
            document.getElementById('sectors-tab').click();
        } else if ('{{ comparison_type }}' === 'company_with_sector') {
            document.getElementById('company-with-sector-tab').click();
        }

        // If company3 or sector3 is present, check the add checkbox
        var hasCompany3 = {% if company3 %}true{% else %}false{% endif %};
        var hasSector3 = {% if sector3 %}true{% else %}false{% endif %};

        if (hasCompany3 && addCompanyCheckbox) {
            addCompanyCheckbox.checked = true;
            document.querySelector('.company3-row').classList.remove('d-none');
        }

        if (hasSector3 && addSectorCheckbox) {
            addSectorCheckbox.checked = true;
            document.querySelector('.sector3-row').classList.remove('d-none');
        }
        
        // Initialize charts if comparison results are available
        {% if comparison_type and comparison_results %}
        // Add chart initialization code here
        {% endif %}
    });
</script>
{% endblock %}